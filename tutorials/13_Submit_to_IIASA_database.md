Uploading scenario data to IIASA database
================
Oliver Richters, 24 October, 2022

Many projects have to upload their scenario data to the database provided by [IIASA](https://iiasa.ac.at/scenario-ensembles-and-database-resources).

## Step 1: model registration

At the beginning of the project, there should be a process to get access to the project Internal Scenario Explorer. In case of problems, contact [Daniel Huppmann](https://iiasa.ac.at/staff/daniel-huppmann).

Model, scenarios and project variables should be registered in the IIASA database. The variable list can be based on the `AR6` template once generate for the IPCC Sixth Assessment Report, or the new template for the NAVIGATE project.

A template file containing the list of variables and associated units may be provided as yaml or xlsx file. It can be used to check the variable names and units of your submission. Save it in your REMIND repository, the suggested place is `./output/export/`.

## Step 2: generate file to upload

You can generate the file to be uploaded by either calling [`piamInterfaces::generateIIASASubmission`](https://github.com/pik-piam/piamInterfaces/blob/master/R/generateIIASASubmission.R) or using a wrapper based on `output.R`

`generateIIASASubmission` requires the following inputs:

- `mifs`: vector of .mif files or directories that contain the .mif files
- `model`: model name as registered in the database, such as "REMIND-MAgPIE 3.0-4.4"
- `iiasatemplate`: optional path to the xlsx or yaml file obtained in the project with the variables and units that are accepted in the database
- `addToScen`: optional string added in front of all scenario names
- `removeFromScen`: optional regular expression of parts to be deleted from the scenario names, such as "C_|_bIT|_bit|_bIt"
- you have to specify at least one of:
  - `mappingFile`: filename of the csv file generated by [`piamInterfaces::generateMappingfile`](https://github.com/pik-piam/piamInterfaces/blob/master/R/generateMappingfile.R) that is used. If `mapping` is also supplied, this file is overwritten
  - `mapping`: vector of templates from [this directory](https://github.com/pik-piam/piamInterfaces/tree/master/inst/templates) (such as `c("AR6", "AR6_NGFS")` or `c("NAVIGATE", "SHAPE")`) that then generates the template (and writes it to `mappingFile` if defined)

Usually, you will find the result in in the `output` subdirectory, but you can adapt this, see  [the function documentation](https://github.com/pik-piam/piamInterfaces/blob/master/R/generateIIASASubmission.R).

Starting from your REMIND directory, you can start this process by running `./output.R`, then selecting `export` and `xlsx_IIASA`. Then choose the directories of the runs you would like to use. This works also for coupled runs, as the `REMIND_generic_*.mif` contains the MAgPIE output since [October 4, 2022](https://github.com/remindmodel/remind/pull/992).

The script requires the inputs as above, expect that it lets you select the `mifs` from a list, and provides additional options:
- mapping: either the path to a mapping file you generated using [`piamInterfaces::generateMappingfile`](https://github.com/pik-piam/piamInterfaces/blob/master/R/generateMappingfile.R), or a vector of templates such as `c("NAVIGATE", "SHAPE")` referring to the last part of the file names in [this piamInterfaces directory](https://github.com/pik-piam/piamInterfaces/tree/master/inst/templates)
- filename_prefix: optional prefix of the resulting outputFile, such as your project name

You can specify the information above in two ways: Either edit [`xlsx_IIASA.R`](../scripts/output/export/xlsx_IIASA.R) and add a project in a similar way to `NGFS_v3` or `ENGAGE_4p5`. You can then start the scripts with:
```
Rscript output.R comp=export output=xlsx_IIASA project=NGFS_v3
```
You do not need to specify `comp` and `output` in the command line, you can just wait to be asked for it.
An alternative is to specify everything individually as command-line arguments:
```
Rscript output.R comp=export output=xlsx_IIASA model="REMIND 3.0" mapping=AR6,AR6_NGFS addToScen=whatever removeFromScen=C_ filename_prefix=test
```
All the information printed to you during the run will also be present in the logfile whose path will be told you at the end.

## Step 3: check submission

Check the logfile carefully for the variables that were omitted, failing summation checks etc. If you need information on a specific variable such as "Emi|CO2", you can run `piamInterfaces::variableInfo("Emi|CO2")` and it will provide a human-readable summary of the places this variable shows up in mapping templates and summation checks. Running `piamInterfaces::variableInfo("Emi|CO2", template = c("AR6", "mapping.csv"))` allows to compare the mapping with the mapping template with respect to this variable.

If you specify `iiasatemplate`, the scripts will delete all the variables not in the template. This can be the reason that summation checks fail, simply because some of the variables that were reported by REMIND were omitted.

Additionally, unit mismatches can cause the script to fail. In the past, IIASA has sometimes changed unit names to correct spelling mistakes or harmonize them. If there were unit mismatches where the units are identical, just spelled differently, you can add them to the named vector `identicalUnits` in [`piamInterfaces::checkIIASASubmission`](https://github.com/pik-piam/piamInterfaces/blob/master/R/checkIIASASubmission.R). So if the project template expects `Mt/yr`, but our templates export it as `Mt/year`, add `"Mt/yr" = "Mt/year"` to the vector, and it will in the future not fail on this unit mismatch but correct it to what is required in the project. Never use this mechanism if the units are not actually identical in their meaning.

## Step 4: upload file

Go to the project internal Scenario Explorer, click on your login name and then on "uploads" and the "plus" in the upper right corner - submit your xlsx file. Do not expect it to work flawlessly on the first try so hope for the best. You will receive an email message with a log and may at some point need the help of the IIASA administrators of your project.
